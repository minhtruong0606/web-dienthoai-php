name: Deploy to EC2

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy via Git Clone
      uses: appleboy/ssh-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USERNAME }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "🚀 Deploying minhtruong0606/web-dienthoai-php..."
          
          WEB_DIR="/var/www/html/webdienthoai-php"
          REPO_URL="https://github.com/minhtruong0606/web-dienthoai-php.git"
          
          # Clear existing files
          sudo rm -rf $WEB_DIR/*
          sudo rm -rf $WEB_DIR/.* 2>/dev/null || true
          
          # Clone repository
          echo "📥 Cloning from GitHub..."
          sudo git clone $REPO_URL $WEB_DIR
          
          # Set permissions
          echo "🔐 Setting permissions..."
          sudo chown -R www-data:www-data $WEB_DIR
          sudo find $WEB_DIR -type d -exec chmod 755 {} \;
          sudo find $WEB_DIR -type f -exec chmod 644 {} \;
          
          # Special permissions for writable directories
          sudo chmod 775 $WEB_DIR/uploads 2>/dev/null || true
          sudo chmod 775 $WEB_DIR/images 2>/dev/null || true
          sudo chmod 775 $WEB_DIR/assets 2>/dev/null || true
          
          # Restart web server
          echo "🔄 Restarting Apache..."
          sudo systemctl restart apache2
          
          echo "✅ DEPLOYMENT COMPLETED!"
          echo "📁 Web Directory: $WEB_DIR"
          echo "📊 Files deployed: $(find $WEB_DIR -type f | wc -l)"
          echo "🌐 Web Server: $(sudo systemctl is-active apache2)"
