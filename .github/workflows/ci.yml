name: CI/CD Pipeline - Production
on:
  push:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'

    - name: Validate PHP Syntax
      run: |
        echo "=== CHECKING PHP SYNTAX ==="
        find . -name "*.php" -exec php -l {} \;
        echo "‚úÖ PHP check completed!"
        
    - name: Test HTML Output and Validation
      run: |
        echo "=== TESTING HTML SYNTAX ==="
        # Ki·ªÉm tra tr·ª±c ti·∫øp trong file PHP
        if grep -q "<title>.*/title>" index.php &&  ! grep -q "<title>.*</title>" index.php; then
          echo "‚ùå L·ªñI: Th·∫ª title kh√¥ng ƒë√≥ng ƒë√∫ng trong index.php"
          grep "<title>" index.php
          exit 1
        fi
        # Ki·ªÉm tra c√°c th·∫ª HTML c∆° b·∫£n
        if ! grep -q "<html" index.php || ! grep -q "</html>" index.php; then
          echo "‚ùå L·ªñI: Thi·∫øu th·∫ª html"
          exit 1
        fi
        echo "‚úÖ HTML syntax validation passed!"

  deploy-to-production:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to EC2
      env:
        EC2_HOST: ${{ secrets.EC2_HOST }}
        EC2_USER: ${{ secrets.EC2_USER }}
        SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        echo "üîß Debug: Checking variables..."
        # Ki·ªÉm tra xem c√°c bi·∫øn c√≥ b·ªã r·ªóng kh√¥ng
        if [ -z "$EC2_USER" ]; then
          echo "‚ùå L·ªñI: Secret EC2_USER b·ªã tr·ªëng."
          exit 1
        fi
        if [ -z "$EC2_HOST" ]; then
          echo "‚ùå L·ªñI: Secret EC2_HOST b·ªã tr·ªëng."
          exit 1
        fi
        if [ -z "$SSH_KEY" ]; then
          echo "‚ùå L·ªñI: Secret EC2_SSH_KEY b·ªã tr·ªëng."
          exit 1
        fi
        
        echo "‚úÖ Variables loaded. User: $EC2_USER, Host: $EC2_HOST"

        echo "üîß Debug: Testing SSH connection..."
        echo "$SSH_KEY" > private_key.pem
        chmod 600 private_key.pem
        
        # Test connection first
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST "echo '‚úÖ SSH Connection successful!'"
        
        # Then deploy
        ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST "
          echo 'üì¶ Pulling latest code...'
          cd /var/www/html/webdienthoai-php
          sudo git pull origin main
          sudo chown -R ubuntu:ubuntu /var/www/html/web-dienthoai-php
          sudo chmod -R 755 /var/www/html/web-dienthoai-php
          sudo systemctl restart apache2
          echo '‚úÖ Deployment completed!'
        "
        
        rm -f private_key.pem
        
        echo "üéâ PRODUCTION DEPLOYMENT SUCCESSFUL!"
        echo "üìä Live at: http://$EC2_HOST"
